PROCESSOR 16f877a
INCLUDE <p16f877a.inc>

ESTADO_MOTOR1  EQU  0XC0
ESTADO_MOTOR2  EQU  0X60
ESTADO_MOTOR3  EQU  0X30
ESTADO_MOTOR4  EQU  0X90

CONTADOR_PASOS   EQU  0X22
CONTADOR_VUELTAS   EQU  0X23

VAR_RETARDO1     EQU  h'10'
VAR_RETARDO2     EQU  h'11'
VAR_RETARDO3     EQU  h'12'

    ORG 0
    GOTO PROGRAMA_PRINCIPAL
    ORG 5

PROGRAMA_PRINCIPAL:
    CALL CONFIG_INICIAL
BUCLE_PRINCIPAL:
    MOVLW  0XFF
    MOVWF  CONTADOR_PASOS
    CLRF   CONTADOR_VUELTAS

    MOVLW  0x0F
    ANDWF  PORTA,W
    ADDWF  PCL,F
    GOTO   DETENER_MOTOR
    GOTO   HORARIO
    GOTO   ANTIHORARIO
    GOTO   UNA_Y_MEDIA_VUELTAS
    GOTO   DOS_VUELTAS
    GOTO   BUCLE_PRINCIPAL

DETENER_MOTOR:
    CLRF   PORTB
    CALL   RETARDO_18ms
    GOTO   BUCLE_PRINCIPAL

HORARIO:
    MOVLW  ESTADO_MOTOR1
    MOVWF  PORTB
    CALL   RETARDO_05ms

    MOVLW  ESTADO_MOTOR2
    MOVWF  PORTB
    CALL   RETARDO_05ms

    MOVLW  ESTADO_MOTOR3
    MOVWF  PORTB
    CALL   RETARDO_05ms

    MOVLW  ESTADO_MOTOR4
    MOVWF  PORTB
    CALL   RETARDO_05ms
    
    MOVLW  0X01
    XORWF  PORTA,W    
    BTFSS  STATUS,Z
    GOTO   BUCLE_PRINCIPAL    
    GOTO   HORARIO

ANTIHORARIO:
    MOVLW  ESTADO_MOTOR4
    MOVWF  PORTB
    CALL   RETARDO_05ms

    MOVLW  ESTADO_MOTOR3
    MOVWF  PORTB
    CALL   RETARDO_05ms

    MOVLW  ESTADO_MOTOR2
    MOVWF  PORTB
    CALL   RETARDO_05ms

    MOVLW  ESTADO_MOTOR1
    MOVWF  PORTB
    CALL   RETARDO_05ms
    
    MOVLW  0X02
    XORWF  PORTA,W    
    BTFSS  STATUS,Z
    GOTO   BUCLE_PRINCIPAL    
    GOTO   ANTIHORARIO

UNA_Y_MEDIA_VUELTAS:
    MOVLW  0X03
    XORWF  CONTADOR_VUELTAS,W
    BTFSC  STATUS, Z    
    GOTO   PARAR_MOTOR

    MOVLW  0X00
    XORWF  CONTADOR_PASOS,W
    BTFSC  STATUS, Z    
    GOTO   REINICIAR_CONTADORES

ROTACION_PASO:
    DECF   CONTADOR_PASOS
    
    MOVLW  ESTADO_MOTOR1
    MOVWF  PORTB
    CALL   RETARDO_05ms

    MOVLW  ESTADO_MOTOR2
    MOVWF  PORTB
    CALL   RETARDO_05ms

    MOVLW  ESTADO_MOTOR3
    MOVWF  PORTB
    CALL   RETARDO_05ms

    MOVLW  ESTADO_MOTOR4
    MOVWF  PORTB
    CALL   RETARDO_05ms

    GOTO UNA_Y_MEDIA_VUELTAS

DOS_VUELTAS:
    MOVLW  0X04
    XORWF  CONTADOR_VUELTAS,W
    BTFSC  STATUS, Z    
    GOTO   PARAR_MOTOR_2

    MOVLW  0X00
    XORWF  CONTADOR_PASOS,W
    BTFSC  STATUS, Z    
    GOTO   REINICIAR_CONTADORES_2

ROTACION_PASO_2:
    DECF   CONTADOR_PASOS

    MOVLW  ESTADO_MOTOR4
    MOVWF  PORTB
    CALL   RETARDO_05ms

    MOVLW  ESTADO_MOTOR3
    MOVWF  PORTB
    CALL   RETARDO_05ms

    MOVLW  ESTADO_MOTOR2
    MOVWF  PORTB
    CALL   RETARDO_05ms

    MOVLW  ESTADO_MOTOR1
    MOVWF  PORTB
    CALL   RETARDO_05ms

    GOTO DOS_VUELTAS

PARAR_MOTOR:
    CLRF   PORTB

    MOVLW  0X03
    XORWF  PORTA,W    
    BTFSS  STATUS,Z
    GOTO   BUCLE_PRINCIPAL    
    GOTO   PARAR_MOTOR

REINICIAR_CONTADORES:    
    MOVLW  0XFF
    MOVWF  CONTADOR_PASOS
    INCF   CONTADOR_VUELTAS
    GOTO   UNA_Y_MEDIA_VUELTAS

PARAR_MOTOR_2:
    CLRF PORTB

    MOVLW  0X04
    XORWF  PORTA,W    
    BTFSS  STATUS,Z
    GOTO   BUCLE_PRINCIPAL    
    GOTO   DOS_VUELTAS

REINICIAR_CONTADORES_2:    
    MOVLW  0XFF
    MOVWF  CONTADOR_PASOS
    INCF   CONTADOR_VUELTAS
    GOTO   DOS_VUELTAS

CONFIG_INICIAL:
    BCF STATUS, RP1    
    BSF STATUS, RP0    
    
    CLRF    TRISB       
    CLRF    TRISC       
    
    MOVLW   0x06        
    MOVWF   ADCON1      
    MOVLW   0x3F
    MOVWF   TRISA

    BCF STATUS, RP0    

    CLRF PORTB
    CLRF PORTA
    CLRF PORTC

    RETURN

RETARDO_05ms: 
    MOVWF   VAR_RETARDO1
BUCLE_RETARDO1: 
    MOVWF   VAR_RETARDO2
BUCLE_RETARDO2: 
    DECFSZ  VAR_RETARDO2
    GOTO    BUCLE_RETARDO2
    DECFSZ  VAR_RETARDO1
    GOTO    BUCLE_RETARDO1
    RETURN

RETARDO_18ms: 
    MOVWF   VAR_RETARDO1
BUCLE_RETARDO3: 
    MOVWF   VAR_RETARDO2
BUCLE_RETARDO4: 
    DECFSZ  VAR_RETARDO2
    GOTO    BUCLE_RETARDO4
    DECFSZ  VAR_RETARDO1
    GOTO    BUCLE_RETARDO3
    RETURN

END